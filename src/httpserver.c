
#include <string.h>

#include "lwip/opt.h"
#include "lwip/arch.h"
#include "lwip/api.h"

#include "httpserver.h"
#include "lights.h"
#include "effects.h"

#ifndef HTTPD_DEBUG
#define HTTPD_DEBUG         LWIP_DBG_OFF
#endif

static const char http_html_hdr[] = "HTTP/1.1 200 OK\r\nContent-type: text/html\r\n\r\n";
const char http_index_html [] = {
    0x3C, 0x68, 0x74, 0x6D, 0x6C, 0x3E, 0x3C, 0x68, 0x65, 0x61, 0x64, 0x3E, 0x3C, 0x6D, 0x65, 0x74, 0x61, 0x20, 0x63, 0x68,
    0x61, 0x72, 0x73, 0x65, 0x74, 0x3D, 0x22, 0x75, 0x74, 0x66, 0x2D, 0x38, 0x22, 0x3E, 0x3C, 0x74, 0x69, 0x74, 0x6C, 0x65,
    0x3E, 0x44, 0x6F, 0x6D, 0x65, 0x6B, 0x3C, 0x2F, 0x74, 0x69, 0x74, 0x6C, 0x65, 0x3E, 0x0A, 0x3C, 0x73, 0x63, 0x72, 0x69,
    0x70, 0x74, 0x20, 0x74, 0x79, 0x70, 0x65, 0x3D, 0x22, 0x74, 0x65, 0x78, 0x74, 0x2F, 0x6A, 0x61, 0x76, 0x61, 0x73, 0x63,
    0x72, 0x69, 0x70, 0x74, 0x22, 0x3E, 0x0A, 0x66, 0x75, 0x6E, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x20, 0x63, 0x69, 0x61, 0x70,
    0x28, 0x63, 0x6D, 0x64, 0x29, 0x20, 0x7B, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x76, 0x61, 0x72, 0x20, 0x78, 0x68, 0x74, 0x74,
    0x70, 0x20, 0x3D, 0x20, 0x6E, 0x65, 0x77, 0x20, 0x58, 0x4D, 0x4C, 0x48, 0x74, 0x74, 0x70, 0x52, 0x65, 0x71, 0x75, 0x65,
    0x73, 0x74, 0x28, 0x29, 0x3B, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x78, 0x68, 0x74, 0x74, 0x70, 0x2E, 0x6F, 0x70, 0x65, 0x6E,
    0x28, 0x22, 0x47, 0x45, 0x54, 0x22, 0x2C, 0x20, 0x22, 0x61, 0x63, 0x6D, 0x64, 0x3F, 0x63, 0x6D, 0x64, 0x3D, 0x22, 0x2B,
    0x63, 0x6D, 0x64, 0x2C, 0x20, 0x66, 0x61, 0x6C, 0x73, 0x65, 0x29, 0x3B, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x78, 0x68, 0x74,
    0x74, 0x70, 0x2E, 0x73, 0x65, 0x6E, 0x64, 0x28, 0x29, 0x3B, 0x7D, 0x0A, 0x3C, 0x2F, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74,
    0x3E, 0x0A, 0x3C, 0x73, 0x74, 0x79, 0x6C, 0x65, 0x20, 0x74, 0x79, 0x70, 0x65, 0x3D, 0x22, 0x74, 0x65, 0x78, 0x74, 0x2F,
    0x63, 0x73, 0x73, 0x22, 0x3E, 0x0A, 0x62, 0x75, 0x74, 0x74, 0x6F, 0x6E, 0x20, 0x7B, 0x66, 0x6F, 0x6E, 0x74, 0x2D, 0x73,
    0x69, 0x7A, 0x65, 0x3A, 0x35, 0x76, 0x77, 0x3B, 0x62, 0x61, 0x63, 0x6B, 0x67, 0x72, 0x6F, 0x75, 0x6E, 0x64, 0x2D, 0x63,
    0x6F, 0x6C, 0x6F, 0x72, 0x3A, 0x23, 0x36, 0x39, 0x36, 0x38, 0x36, 0x36, 0x3B, 0x63, 0x6F, 0x6C, 0x6F, 0x72, 0x3A, 0x23,
    0x46, 0x46, 0x46, 0x46, 0x44, 0x44, 0x3B, 0x20, 0x6D, 0x61, 0x72, 0x67, 0x69, 0x6E, 0x3A, 0x35, 0x70, 0x78, 0x3B, 0x20,
    0x77, 0x69, 0x64, 0x74, 0x68, 0x3A, 0x39, 0x30, 0x25, 0x3B, 0x7D, 0x0A, 0x3C, 0x2F, 0x73, 0x74, 0x79, 0x6C, 0x65, 0x3E,
    0x3C, 0x2F, 0x68, 0x65, 0x61, 0x64, 0x3E, 0x3C, 0x62, 0x6F, 0x64, 0x79, 0x20, 0x73, 0x74, 0x79, 0x6C, 0x65, 0x3D, 0x22,
    0x62, 0x61, 0x63, 0x6B, 0x67, 0x72, 0x6F, 0x75, 0x6E, 0x64, 0x2D, 0x63, 0x6F, 0x6C, 0x6F, 0x72, 0x3A, 0x23, 0x38, 0x32,
    0x35, 0x62, 0x31, 0x34, 0x3B, 0x20, 0x63, 0x6F, 0x6C, 0x6F, 0x72, 0x3A, 0x23, 0x46, 0x46, 0x46, 0x46, 0x44, 0x44, 0x3B,
    0x20, 0x66, 0x6F, 0x6E, 0x74, 0x2D, 0x73, 0x69, 0x7A, 0x65, 0x3A, 0x20, 0x35, 0x76, 0x77, 0x3B, 0x22, 0x3E, 0x0A, 0x4F,
    0xC5, 0x9B, 0x77, 0x69, 0x65, 0x74, 0x6C, 0x65, 0x6E, 0x69, 0x65, 0x3A, 0x3C, 0x62, 0x72, 0x2F, 0x3E, 0x0A, 0x3C, 0x62,
    0x75, 0x74, 0x74, 0x6F, 0x6E, 0x20, 0x6F, 0x6E, 0x63, 0x6C, 0x69, 0x63, 0x6B, 0x3D, 0x22, 0x63, 0x69, 0x61, 0x70, 0x28,
    0x27, 0x6C, 0x73, 0x27, 0x29, 0x22, 0x20, 0x73, 0x74, 0x79, 0x6C, 0x65, 0x3D, 0x22, 0x77, 0x69, 0x64, 0x74, 0x68, 0x3A,
    0x36, 0x30, 0x25, 0x3B, 0x22, 0x3E, 0x53, 0x61, 0x6C, 0x6F, 0x6E, 0x3C, 0x2F, 0x62, 0x75, 0x74, 0x74, 0x6F, 0x6E, 0x3E,
    0x0A, 0x3C, 0x62, 0x75, 0x74, 0x74, 0x6F, 0x6E, 0x20, 0x6F, 0x6E, 0x63, 0x6C, 0x69, 0x63, 0x6B, 0x3D, 0x22, 0x63, 0x69,
    0x61, 0x70, 0x28, 0x27, 0x6C, 0x77, 0x27, 0x29, 0x22, 0x20, 0x73, 0x74, 0x79, 0x6C, 0x65, 0x3D, 0x22, 0x77, 0x69, 0x64,
    0x74, 0x68, 0x3A, 0x33, 0x30, 0x25, 0x3B, 0x22, 0x3E, 0x57, 0x43, 0x3C, 0x2F, 0x62, 0x75, 0x74, 0x74, 0x6F, 0x6E, 0x3E,
    0x0A, 0x3C, 0x62, 0x72, 0x2F, 0x3E, 0x0A, 0x47, 0xC5, 0x82, 0x75, 0x70, 0x6F, 0x74, 0x79, 0x3A, 0x3C, 0x62, 0x72, 0x2F,
    0x3E, 0x0A, 0x3C, 0x62, 0x75, 0x74, 0x74, 0x6F, 0x6E, 0x20, 0x6F, 0x6E, 0x63, 0x6C, 0x69, 0x63, 0x6B, 0x3D, 0x22, 0x63,
    0x69, 0x61, 0x70, 0x28, 0x27, 0x73, 0x69, 0x6B, 0x75, 0x27, 0x29, 0x22, 0x3E, 0x53, 0x69, 0x6B, 0x75, 0x3C, 0x2F, 0x62,
    0x75, 0x74, 0x74, 0x6F, 0x6E, 0x3E, 0x0A, 0x3C, 0x62, 0x75, 0x74, 0x74, 0x6F, 0x6E, 0x20, 0x6F, 0x6E, 0x63, 0x6C, 0x69,
    0x63, 0x6B, 0x3D, 0x22, 0x63, 0x69, 0x61, 0x70, 0x28, 0x27, 0x64, 0x69, 0x73, 0x63, 0x6F, 0x27, 0x29, 0x22, 0x3E, 0x44,
    0x69, 0x73, 0x63, 0x6F, 0x3C, 0x2F, 0x62, 0x75, 0x74, 0x74, 0x6F, 0x6E, 0x3E, 0x0A, 0x3C, 0x62, 0x75, 0x74, 0x74, 0x6F,
    0x6E, 0x20, 0x6F, 0x6E, 0x63, 0x6C, 0x69, 0x63, 0x6B, 0x3D, 0x22, 0x63, 0x69, 0x61, 0x70, 0x28, 0x27, 0x61, 0x6C, 0x61,
    0x72, 0x6D, 0x27, 0x29, 0x22, 0x3E, 0x41, 0x6C, 0x61, 0x72, 0x6D, 0x3C, 0x2F, 0x62, 0x75, 0x74, 0x74, 0x6F, 0x6E, 0x3E,
    0x0A, 0x3C, 0x2F, 0x62, 0x6F, 0x64, 0x79, 0x3E, 0x0A, 0x3C, 0x2F, 0x68, 0x74, 0x6D, 0x6C, 0x3E, 0x0A, 0x0A,
};

//"<html><head><title>Congrats!</title></head><body><h1>Welcome to our lwIP HTTP server!</h1><p>This is a small test page, served by httpserver-netconn.</body></html>";

/** Serve one HTTP connection accepted in the http thread */
static void
http_server_netconn_serve(struct netconn *conn)
{
  struct netbuf *inbuf;
  char *buf;
  u16_t buflen;
  err_t err;

  /* Read the data from the port, blocking if nothing yet there.
   We assume the request (the part we care about) is in one netbuf */
  err = netconn_recv(conn, &inbuf);

  if (err == ERR_OK) {
    netbuf_data(inbuf, (void**)&buf, &buflen);

    /* Is this an HTTP GET command? (only check the first 5 chars, since
    there are other formats for GET, and we're keeping it very simple )*/
    if (buflen>=5 &&
        buf[0]=='G' &&
        buf[1]=='E' &&
        buf[2]=='T' &&
        buf[3]==' ' &&
        buf[4]=='/' )
    {
      //printf("%s\n", buf);
      if (0 == strncmp("acmd?cmd=", &buf[5], 9))
      {
          printf("got command %.8s\n", &buf[5]);

          if ('l' == buf[14])
          {
              lights_cmd(&buf[14]);
          }
          else if (0 == strncmp("siku", &buf[14], 4))
          {
              effects_go_to_wc();
          }
          else if (0 == strncmp("disco", &buf[14], 5))
          {
              effects_disco();
          }
          else if (0 == strncmp("alarm", &buf[14], 5))
          {
              effects_alarm();
          }
      }


      /* Send the HTML header
             * subtract 1 from the size, since we don't send the \0 in the string
             * NETCONN_NOCOPY: our data is const static, so no need to copy it
       */
      netconn_write(conn, http_html_hdr, sizeof(http_html_hdr)-1, NETCONN_NOCOPY);

      /* Send our HTML page */
      netconn_write(conn, http_index_html, sizeof(http_index_html)-1, NETCONN_NOCOPY);
    }
  }
  /* Close the connection (server closes in HTTP) */
  netconn_close(conn);

  /* Delete the buffer (netconn_recv gives us ownership,
   so we have to make sure to deallocate the buffer) */
  netbuf_delete(inbuf);
}

static struct netconn *s_conn;

bool http_server_cycle(void)
{
    struct netconn *newconn;
    err_t err;

    err = netconn_accept(s_conn, &newconn);
    if (err == ERR_OK) {
        http_server_netconn_serve(newconn);
        netconn_delete(newconn);
    }

    return ERR_OK == err;
}

/** Initialize the HTTP server (start its thread) */
void
http_server_netconn_init(void)
{
    /* Create a new TCP connection handle */
    /* Bind to port 80 (HTTP) with default IP address */
    s_conn = netconn_new(NETCONN_TCP);
    netconn_bind(s_conn, IP_ADDR_ANY, 80);
    LWIP_ERROR("http_server: invalid conn", (s_conn != NULL), return;);

    /* Put the connection into LISTEN state */
    netconn_listen(s_conn);
}

void http_server_netconn_deinit(void)
{
    netconn_close(s_conn);
    netconn_delete(s_conn);
}

